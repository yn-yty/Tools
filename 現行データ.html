<!DOCTYPE html>
<!-- HTML5の宣言 -->
<html lang="ja">
<!-- 日本語のページであることを示す -->
<head>
    <meta charset="UTF-8">
    <!-- 文字エンコーディングをUTF-8に設定 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- モバイル端末での表示を最適化 -->
    <title>辞書チャットボット</title>
    <!-- ブラウザのタブに表示されるタイトル -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Googleのマテリアルアイコンを使用するためのリンク -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap">
    <!-- SF Pro Displayフォントを使用するためのリンク -->
    <style>
        /* 基本設定 */
        :root {
            /* カラーパレット - アプリ全体で使用する色を変数として定義 */
            --primary-color: #5B86E5; /* メインカラー - ボタンやアクセントに使用 */
            --primary-light: #F2F5FC; /* 薄いメインカラー - ホバー時の背景などに使用 */
            --hover-color: #4A75D4; /* ホバー時の色 - ボタンにマウスを乗せた時の色 */
            --accent-color: #2B4EA3; /* アクセントカラー - 強調したい部分に使用 */
            --background-color: #FFFFFF; /* 背景色 - 白色 */
            --neutral-color: #F0F2F5; /* 中立的な色 - メッセージの背景などに使用 */
            --border-color: #E1E5EB; /* 境界線の色 */
            --text-color: #333333; /* テキストの色 - 濃いグレー */
            --error-color: #D32F2F; /* エラー表示用の赤色 */
            
            /* レイアウト設定 - 画面サイズに応じた高さを定義 */
            --input-height-pc: 100px; /* PC用の入力エリアの高さ */
            --input-height-mobile: 80px; /* モバイル用の入力エリアの高さ */
            --input-height-small: 70px; /* 小型デバイス用の入力エリアの高さ */
            --chat-max-width: 600px; /* チャット画面の最大幅 */
            --message-max-width: 70%; /* メッセージの最大幅（画面幅に対する割合） */
        }

        /* 基本レイアウト - ページ全体の設定 */
        body {
            font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, Arial, sans-serif;
            /* フォントファミリーの設定。SF Pro Displayが利用できない場合は順次代替フォントを使用 */
            display: flex;
            flex-direction: column;
            align-items: center;
            /* 縦方向に要素を配置し、中央揃えに */
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            /* 画面のスクロールを防止 */
        }

        /* チャットコンテナ - メッセージを表示する主要な領域 */
        .chat-container {
            width: 100%;
            max-width: var(--chat-max-width);
            height: calc(100vh - var(--input-height-pc));
            /* 画面の高さから入力エリアの高さを引いた分 */
            padding: 20px;
            margin: 0 auto var(--input-height-pc);
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow-y: auto;
            /* 縦方向のスクロールを可能に */
            box-sizing: border-box;
            scrollbar-width: none;
            -ms-overflow-style: none;
            /* スクロールバーを非表示に */
            padding-bottom: 30px; /* 下部に余白を追加 */
        }

        /* Webkit系ブラウザ（Chrome, Safari等）でスクロールバーを非表示にする */
        .chat-container::-webkit-scrollbar {
            display: none;
        }

        /* メッセージ共通スタイル - ユーザーとボットのメッセージの基本設定 */
        .message {
            position: relative;
            max-width: var(--message-max-width);
            width: fit-content;
            margin: 8px 0;
            font-size: 15px;
            line-height: 1.4;
            display: flex;
            align-items: flex-start;
        }

        /* メッセージの内容を包む要素のスタイル */
        .message-content {
            padding: 10px 14px;
            border-radius: 12px;
            position: relative;
            width: fit-content;
        }

        /* ボットのメッセージ専用スタイル */
        .bot-message {
            margin-right: auto;
            /* 左寄せ */
            padding: 0;
        }

        .bot-message .message-content {
            background-color: var(--neutral-color);
            border-radius: 12px 12px 12px 4px;
            /* 左下のみ角を小さく */
        }

        /* ボットのアバター画像スタイル */
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            /* 円形に切り取り */
            margin-right: 12px;
            flex-shrink: 0;
            /* サイズを固定 */
        }

        /* ユーザーのメッセージ専用スタイル */
        .user-message {
            margin-left: auto;
            /* 右寄せ */
            padding: 0;
            user-select: none;
            /* テキスト選択を無効化 */
            cursor: default;
            justify-content: flex-end;
            width: 100%;
            display: flex;
        }

        .user-message .message-content {
            background-color: var(--primary-color);
            color: white;
            border-radius: 12px 12px 4px 12px;
            /* 右下のみ角を小さく */
        }

        /* 入力エリア - テキスト入力と送信ボタンを含む領域 */
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--input-height-pc);
            padding: 16px 0;
            background: var(--background-color);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -4px 12px rgba(0,0,0,0.04);
            /* 上部に影を付けて浮いているように見せる */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 入力エリアの内側のラッパー */
        .input-wrapper {
            width: 100%;
            max-width: var(--chat-max-width);
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 0 20px;
        }

        /* テキスト入力フィールド */
        .input-container textarea {
            flex: 1;
            height: 52px;
            padding: 16px 15px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            resize: none;
            /* サイズ変更を無効化 */
            transition: border-color 0.2s, box-shadow 0.2s;
            /* 境界線と影のアニメーション */
        }

        /* テキスト入力フィールドがフォーカスされた時のスタイル */
        .input-container textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
            /* フォーカス時に青い枠と影を表示 */
        }

        /* 送信ボタン */
        .input-container button {
            height: 32px;
            padding: 0 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            /* 色と大きさのアニメーション */
        }

        /* 送信ボタンのホバー時のスタイル */
        .input-container button:hover {
            background-color: var(--hover-color);
            /* より濃い青色に変化 */
        }

        /* 送信ボタンのクリック時のスタイル */
        .input-container button:active {
            transform: scale(0.98);
            /* わずかに縮小してクリック感を演出 */
        }

        /* 候補ボタンのコンテナ */
        .suggestion-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 4px;
        }

        /* 候補ボタン */
        .bot-message button {
            background-color: white;
            border: 1px solid var(--border-color);
            color: var(--primary-color);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex: 0 1 auto;
            white-space: nowrap;
            /* テキストの折り返しを防止 */
        }

        /* 候補ボタンのホバー時のスタイル */
        .bot-message button:hover {
            background-color: var(--primary-light);
            /* 薄い青色の背景に変化 */
        }

        /* コピーボタン */
        .copy-button {
            position: absolute;
            left: calc(100% + 8px);
            /* メッセージの右側に配置 */
            top: 50%;
            transform: translateY(-50%);
            /* 垂直方向の中央揃え */
            background: none;
            border: none;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            transition: all 0.2s ease;
        }

        /* コピーボタンのアイコン */
        .copy-button .material-icons {
            font-size: 16px;
            color: #8E8E93;
            transition: all 0.2s ease;
        }

        /* コピー成功時のボタンスタイル */
        .copy-button.copied .material-icons {
            color: var(--primary-color);
            /* アイコンを青色に変化 */
        }

        /* レスポンシブ対応 - タブレットとスマートフォン向けの設定 */
        @media (max-width: 768px) {
            body {
                position: fixed;
                width: 100%;
                height: 100%;
            }

            .chat-container {
                height: calc(100vh - var(--input-height-mobile));
                margin-bottom: var(--input-height-mobile);
                padding: 15px;
                border-radius: 0;
                border: none;
                /* モバイルでは境界線を削除 */
                padding-bottom: 20px; /* モバイル用の下部余白調整 */
            }

            .message {
                max-width: 85%;
                /* メッセージの幅を広げる */
            }

            .input-container {
                height: var(--input-height-mobile);
                padding: 10px;
            }

            .copy-button {
                left: calc(100% + 6px);
                /* コピーボタンの位置を調整 */
            }
        }

        /* 小型デバイス（iPhone SE等）向けの設定 */
        @media (max-width: 320px) {
            .chat-container {
                height: calc(100vh - var(--input-height-small));
                margin-bottom: var(--input-height-small);
                padding-bottom: 15px; /* 小型デバイス用の下部余白調整 */
            }

            .message {
                max-width: 90%;
                font-size: 14px;
                /* フォントサイズを小さく */
            }

            .input-container textarea {
                font-size: 14px;
                /* 入力欄のフォントサイズも小さく */
            }
        }
    </style>
</head>
<body>

<!-- チャットメッセージを表示する領域 -->
<div class="chat-container" id="chatContainer"></div>

<!-- 入力エリア -->
<div class="input-container">
    <div class="input-wrapper">
        <textarea id="userInput" placeholder="文章を入力してください"></textarea>
        <button onclick="ChatManager.sendMessage()">送信</button>
    </div>
</div>

<script>
    // アプリケーション全体で使用する定数を定義
    const CONSTANTS = {
        BOT_CLASS: 'bot-message', // ボットメッセージのCSS クラス
        USER_CLASS: 'user-message', // ユーザーメッセージのCSS クラス
        BOT_AVATAR: 'https://api.dicebear.com/7.x/bottts/svg?seed=bot', // ボットのアバター画像URL
        COPY_TIMEOUT: 1000, // コピー完了表示の持続時間（ミリ秒）
    };

    // 辞書データ - 用語と説明のペアを定義
    const dictionary = {
        "青パト": "青色のライトをつけた車でパトロール（見て回る）こと",
        "歩きたばこ": "歩いている時に",
        "暗証番号": "あなたが決める秘密の番号です。電子証明（№352）を使うときに必要です。",
        "あんしん電話": "急に体調が悪くなった時、すぐに家族や近所の人にお知らせする機械。一人暮らしの障害がある人に便利です。",
        "安否確認": "生きているかどうか、ケガをしていないかを調べること"
    };

    // チャットの主要な機能を管理するクラス
    class ChatManager {
        // メッセージを送信する処理
        static sendMessage() {
            const input = document.getElementById("userInput").value.trim();
            if (!input) return; // 空の入力は無視

            this.addUserMessage(input);
            this.scrollToBottom();
            
            // 少し遅延を入れて自然な会話の流れを演出
            setTimeout(() => {
                this.findAndShowSuggestions(input);
                this.scrollToBottom();
            }, 500);
            this.clearInput();
        }

        // ユーザーメッセージを追加
        static addUserMessage(text) {
            MessageRenderer.addMessage(text, CONSTANTS.USER_CLASS);
        }

        // 入力テキストから辞書の候補を検索して表示
        static findAndShowSuggestions(input) {
            const suggestions = Object.keys(dictionary).filter(word => input.includes(word));
            if (suggestions.length > 0) {
                const buttons = suggestions.map(this.createSuggestionButton).join("");
                MessageRenderer.addMessage(`候補:<div class="suggestion-container">${buttons}</div>`, CONSTANTS.BOT_CLASS);
            } else {
                MessageRenderer.addMessage("候補が見つかりませんでした。", CONSTANTS.BOT_CLASS, true);
            }
        }

        // 候補ボタンのHTML要素を生成
        static createSuggestionButton(word) {
            return `<button onclick="ChatManager.showDefinition('${word}')">${word}</button>`;
        }

        // 選択された用語の説明を表示
        static showDefinition(word) {
            const definition = dictionary[word];
            const message = `【${word}】: ${definition}`;
            MessageRenderer.addMessage(message, CONSTANTS.BOT_CLASS);
            this.scrollToBottom();
        }

        // 入力フィールドをクリア
        static clearInput() {
            document.getElementById("userInput").value = '';
        }

        // チャット画面を最下部にスクロール
        static scrollToBottom() {
            const chatContainer = document.getElementById("chatContainer");
            chatContainer.scrollTo({
                top: chatContainer.scrollHeight + 20, // 20pxの余白を追加
                behavior: 'smooth' // スムーズスクロール
            });
        }
    }

    // メッセージの表示を担当するクラス
    class MessageRenderer {
        // メッセージを画面に追加
        static addMessage(text, className, noCopy = false) {
            const messageDiv = this.createMessageDiv(className);
            
            // ボットメッセージの場合はアバターを追加
            if (className === CONSTANTS.BOT_CLASS) {
                messageDiv.appendChild(this.createAvatar());
            }
            
            const messageContent = this.createMessageContent(text);
            messageDiv.appendChild(messageContent);

            // ボットの通常メッセージにはコピーボタンを追加
            if (className === CONSTANTS.BOT_CLASS && !text.startsWith('候補:') && !noCopy) {
                messageContent.appendChild(this.createCopyButton(text));
            }

            document.getElementById("chatContainer").appendChild(messageDiv);
        }

        // メッセージの外枠となるdiv要素を作成
        static createMessageDiv(className) {
            const div = document.createElement("div");
            div.classList.add("message", className);
            return div;
        }

        // ボットのアバター画像要素を作成
        static createAvatar() {
            const avatar = document.createElement("img");
            avatar.classList.add("avatar");
            avatar.src = CONSTANTS.BOT_AVATAR;
            avatar.alt = "Bot";
            return avatar;
        }

        // メッセージの内容を表示する要素を作成
        static createMessageContent(text) {
            const content = document.createElement("div");
            content.classList.add("message-content");
            content.innerHTML = text;
            return content;
        }

        // コピーボタンを作成
        static createCopyButton(text) {
            const button = document.createElement("button");
            button.classList.add("copy-button");
            button.innerHTML = '<span class="material-icons">content_copy</span>';
            button.onclick = (event) => this.handleCopy(text, event);
            return button;
        }

        // コピー機能の処理
        static async handleCopy(text, event) {
            try {
                // HTMLタグを除去してテキストのみをコピー
                const cleanText = text.replace(/<[^>]*>/g, '');
                await navigator.clipboard.writeText(cleanText);
                const button = event.currentTarget;
                const icon = button.querySelector('.material-icons');
                
                // コピー成功時のアイコンとスタイルの変更
                icon.textContent = 'check';
                button.classList.add('copied');
                
                // 一定時間後に元のスタイルに戻す
                setTimeout(() => {
                    icon.textContent = 'content_copy';
                    button.classList.remove('copied');
                }, CONSTANTS.COPY_TIMEOUT);
            } catch (error) {
                console.error('コピーに失敗しました:', error);
            }
        }
    }

    // ページ読み込み完了時の初期化処理
    document.addEventListener('DOMContentLoaded', () => {
        const userInput = document.getElementById("userInput");
        const sendButton = document.querySelector('.input-container button');

        // Enterキーでメッセージを送信（Shift+Enterは改行）
        userInput.addEventListener("keydown", e => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                ChatManager.sendMessage();
            }
        });

        // 送信ボタンのクリックイベント
        sendButton.addEventListener("click", () => {
            ChatManager.sendMessage();
        });
    });
</script>

</body>
</html>