<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カンバンボード</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            padding: 20px;
        }
        #kanban-board {
            display: flex;
            gap: 12px;
            padding: 20px;
            overflow-x: auto;
            align-items: flex-start;
            width: fit-content;
        }
        .column {
            width: 320px;
            min-width: 320px;
            flex: 0 0 320px;
            background-color: #f5f5f5;
            border-radius: 4px;
            padding: 12px;
            min-height: 600px;
            height: 600px;
            display: flex;
            flex-direction: column;
        }
        .column h2 {
            text-align: center;
            color: #333;
            margin: 10px;
            font-size: 18px;
            padding: 10px;
            border-bottom: 2px solid #ddd;
            background-color: #ebecf0;
        }
        .task-list {
            flex: 1;
            overflow-y: auto;
            min-height: 450px;
        }
        .task {
            background-color: white;
            padding: 12px;
            margin: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            position: relative;
            z-index: 1;
        }
        
        .task:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }
        
        .task-main {
            font-size: 14px;
            margin-bottom: 8px;
            color: #333;
        }
        
        .task-info {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #666;
            border-top: 1px solid #eee;
            padding-top: 8px;
            justify-content: flex-end;
        }
        
        .task-info span {
            display: flex;
            align-items: center;
        }
        
        .task-info .dates {
            margin-right: 8px;
        }
        
        .priority {
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .priority-high { 
            color: #dc3545;
            font-weight: 600;
        }
        .priority-medium { 
            color: #ffc107;
            font-weight: 600;
        }
        .priority-low { 
            color: #28a745;
            font-weight: 600;
        }
        
        .task-tooltip {
            display: none;
            position: absolute;
            background: #333;
            color: #fff;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 260px;
            width: max-content;
            z-index: 1000;
            bottom: -5px;
            left: 50%;
            transform: translate(-50%, 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: normal;
            word-wrap: break-word;
        }
        
        .task-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 6px 6px 6px;
            border-style: solid;
            border-color: transparent transparent #333 transparent;
        }
        
        .context-menu {
            display: none;
            position: fixed;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 8px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            padding: 5px 0;
            min-width: 220px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 0.5px solid rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }
        
        .menu-item {
            padding: 4px 12px;
            margin: 0 5px;
            border-radius: 4px;
            font-size: 13px;
            color: #000000;
            cursor: default;
            display: flex;
            align-items: center;
            height: 22px;
            transition: background-color 0.1s;
        }
        
        .menu-item:hover {
            background-color: #007AFF;
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1001;
            min-width: 300px;
        }
        
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal h3 {
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-footer {
            margin-top: 20px;
            text-align: right;
        }

        .modal-footer button {
            padding: 6px 12px;
            margin-left: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #modal-save {
            background: #4a90e2;
            color: white;
        }

        #modal-cancel {
            background: #eee;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .add-task-input {
            width: 90%;
            padding: 8px;
            margin: 10px auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: block;
            font-size: 14px;
            background-color: white;
        }
        .add-task-input:focus {
            outline: none;
            border-color: #4a90e2;
        }
        .task-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
        }
        .delete-task {
            color: #ff4444;
            cursor: pointer;
            font-size: 12px;
        }

        .task-main[contenteditable="true"] {
            outline: 2px solid #4a90e2;
            padding: 2px;
            border-radius: 2px;
        }

        .task-main {
            min-height: 1em;
        }

        .priority {
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
        }

        .priority-high { 
            color: #dc3545;
            font-weight: 600;
        }
        .priority-medium { 
            color: #ffc107;
            font-weight: 600;
        }
        .priority-low { 
            color: #28a745;
            font-weight: 600;
        }

        /* ドラッグ中のタスク用のタイル */
        .task.dragging {
            opacity: 0.5;
            position: absolute;
            pointer-events: none;
        }

        /* ドラッグ中のゴーストイージ非表示 */
        .task.dragging * {
            pointer-events: none;
        }

        /* カラムのドラッグオーバー時のスタイル */
        .column.drag-over {
            background-color: #e0e0e0;
        }

        /* 完了カラム特有の定を追加 */
        #done .task.dragging {
            opacity: 0;
        }

        .csv-controls {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            width: 100%;
            justify-content: center;
        }

        .csv-controls button {
            width: 140px;
            height: 32px;
            padding: 0;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .csv-controls button:hover {
            background-color: #357abd;
        }

        .csv-controls input[type="file"] {
            display: none;
        }

        .csv-controls button#import-csv-btn {
            background-color: #4a90e2;
            color: white;
        }

        .csv-controls button#import-csv-btn:hover {
            background-color: #357abd;
        }

        .csv-controls button#export-csv {
            background-color: #4a90e2;
            color: white;
        }

        .csv-controls button#export-csv:hover {
            background-color: #357abd;
        }

        #done {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            max-height: 800px;
        }

        #done .task-list {
            margin-bottom: 12px;
        }

        /* 完了カラムとCSVボタンをまとめるコンテナ */
        #done-container {
            display: flex;
            flex-direction: column;
            width: 320px;
            min-width: 320px;
        }

        /* 期限切れと期限間近のタスクのスタイル */
        .task.overdue {
            background-color: #ffebee;
        }

        .task.due-soon {
            background-color: #fff3e0;
        }

        /* モーダル内のクリアボタンのスタイル */
        .form-group button {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
            font-size: 12px;
        }

        .form-group button:hover {
            background-color: #f5f5f5;
        }

        /* ツールボックスのスタイルを修正 */
        .toolbox {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 12px;
            margin-bottom: 20px;
            width: fit-content;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .toolbox-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .toolbox-group:not(:last-child) {
            padding-right: 12px;
            border-right: 2px solid #eee;
        }

        .toolbox button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            color: #333;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }

        .toolbox select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            width: auto;
        }

        /* メインコンテナのスタイル調整 */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 「全て」ボタン用の特別なスタイル */
        #show-all {
            background-color: #4a90e2;
            color: white;
            font-weight: 500;
            min-width: 80px;
        }

        /* グループ間の区切りのスタイルを強調 */
        .toolbox-group:not(:last-child) {
            padding-right: 16px;
            margin-right: 16px;
            border-right: 2px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbox">
            <div class="toolbox-group">
                <button id="show-all">全て</button>
                <button>期限あり</button>
                <button>期限なし</button>
                <button>今日期限</button>
                <button>期限切れ</button>
            </div>
            <div class="toolbox-group">
                <select>
                    <option value="all">全て</option>
                    <option value="high">優先度：高</option>
                    <option value="medium">優先度：中</option>
                    <option value="low">優先度：低</option>
                </select>
            </div>
        </div>
        <div id="kanban-board">
            <div class="column" id="todo">
                <h2>未着手</h2>
                <input type="text" class="add-task-input" placeholder="新しいタスクを追加" data-column="todo">
                <div class="task-list"></div>
            </div>
            <div class="column" id="in-progress">
                <h2>進行中</h2>
                <input type="text" class="add-task-input" placeholder="新しいタスクを追加" data-column="in-progress">
                <div class="task-list"></div>
            </div>
            <div id="done-container">
                <div class="column" id="done">
                    <h2>完了</h2>
                    <input type="text" class="add-task-input" placeholder="新しいタスクを追加" data-column="done">
                    <div class="task-list"></div>
                </div>
                <div class="csv-controls">
                    <button id="export-csv">CSVエクスポート</button>
                    <input type="file" id="import-csv" accept=".csv" style="display: none;">
                    <button id="import-csv-btn">CSVインポート</button>
                </div>
            </div>
        </div>
    </div>
    <div id="contextMenu" class="context-menu">
        <div class="menu-item">タイトル</div>
        <div class="menu-item">開始日</div>
        <div class="menu-item">期限日</div>
        <div class="menu-item">重要度</div>
        <div class="menu-item">詳細</div>
        <div class="menu-item">削除</div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <div id="modal-body"></div>
            <div class="modal-footer">
                <button id="modal-save">保存</button>
                <button id="modal-cancel">キャンセル</button>
            </div>
        </div>
    </div>
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <script>
        // 定数の集約
        const CONSTANTS = {
            PRIORITIES: {
                HIGH: 'high',
                MEDIUM: 'medium',
                LOW: 'low'
            },
            PRIORITY_WEIGHTS: {
                high: 3,
                medium: 2,
                low: 1
            },
            PRIORITY_LABELS: {
                high: '高',
                medium: '中',
                low: '低'
            },
            COLUMNS: ['todo', 'in-progress', 'done']
        };

        // ユーティ関数の集約
        const utils = {
            formatDate(dateStr) {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
            },

            convertDisplayDateToISO(displayDate) {
                if (displayDate === '-') return '';
                const [month, day] = displayDate.split('/');
                return `${new Date().getFullYear()}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            },

            getPriorityText(priority) {
                return CONSTANTS.PRIORITY_LABELS[priority] || CONSTANTS.PRIORITY_LABELS.medium;
            }
        };

        // モーダル管理クラス
        class ModalManager {
            static show(title, content, onSave) {
                const modal = document.getElementById('edit-modal');
                const modalBackdrop = document.getElementById('modal-backdrop');
                
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').innerHTML = content;
                
                modal.style.display = 'block';
                modalBackdrop.style.display = 'block';

                const handleSave = () => {
                    onSave();
                    this.hide();
                };

                const handleCancel = () => this.hide();

                document.getElementById('modal-save').addEventListener('click', handleSave, { once: true });
                document.getElementById('modal-cancel').addEventListener('click', handleCancel, { once: true });
            }

            static hide() {
                document.getElementById('edit-modal').style.display = 'none';
                document.getElementById('modal-backdrop').style.display = 'none';
            }
        }

        // タスク管理ラス
        class TaskManager {
            static currentDateFilter = 'all';
            static currentPriorityFilter = 'all';

            static draggedTask = null;

            static createTask(text, columnId, startDate = '', dueDate = '', priority = CONSTANTS.PRIORITIES.MEDIUM, detail = '', completedDate = '') {
                const task = document.createElement("div");
                task.className = "task";
                task.draggable = true;
                task.dataset.detail = detail;
                task.dataset.completedDate = completedDate;
                task.innerHTML = this.getTaskHTML(text, startDate, dueDate, priority, detail, completedDate);
                
                this.attachTaskEventListeners(task);
                document.querySelector(`#${columnId} .task-list`).appendChild(task);
                this.updateTaskCount();
                this.updateTaskStatus(task);
                return task;
            }

            static getTaskHTML(text, startDate, dueDate, priority, detail, completedDate = '') {
                return `
                    <div class="task-main">${text}</div>
                    <div class="task-info">
                        <span class="dates">${utils.formatDate(startDate)} → ${utils.formatDate(dueDate)}</span>
                        <span class="priority priority-${priority}">[${utils.getPriorityText(priority)}]</span>
                    </div>
                    ${detail ? '<div class="task-tooltip">' + detail + '</div>' : ''}
                `;
            }

            static attachTaskEventListeners(task) {
                task.addEventListener("dragstart", (e) => {
                    TaskManager.draggedTask = task;
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                task.addEventListener("dragend", () => {
                    TaskManager.draggedTask = null;
                });

                task.addEventListener("contextmenu", e => this.showContextMenu(e, task));

                if (task.dataset.detail) {
                    const tooltip = task.querySelector('.task-tooltip');
                    if (tooltip) {
                        let tooltipTimeout;
                        
                        task.addEventListener("mouseenter", () => {
                            clearTimeout(tooltipTimeout);
                            tooltipTimeout = setTimeout(() => {
                                tooltip.style.display = 'block';
                                tooltip.textContent = task.dataset.detail;
                            }, 200);
                        });
                        
                        task.addEventListener("mouseleave", () => {
                            clearTimeout(tooltipTimeout);
                            tooltip.style.display = 'none';
                        });
                    }
                }
            }

            static showContextMenu(e, task) {
                e.preventDefault();
                this.selectedTask = task;
                const menu = document.getElementById('contextMenu');
                const { clientX: mouseX, clientY: mouseY } = e;
                const { innerWidth: windowWidth, innerHeight: windowHeight } = window;
                const { offsetWidth: menuWidth, offsetHeight: menuHeight } = menu;

                menu.style.display = 'block';
                menu.style.left = `${mouseX + menuWidth > windowWidth ? mouseX - menuWidth : mouseX}px`;
                menu.style.top = `${mouseY + menuHeight > windowHeight ? mouseY - menuHeight : mouseY}px`;
            }

            static sortTasks(columnId) {
                const taskList = document.querySelector(`#${columnId} .task-list`);
                if (!taskList) return;

                const tasks = Array.from(taskList.querySelectorAll('.task'));
                tasks.sort(this.compareTasksForSort);
                
                taskList.innerHTML = '';
                tasks.forEach(task => taskList.appendChild(task));
            }

            static compareTasksForSort(a, b) {
                const columnId = a.closest('.column').id;
                
                // 完了カラムの場合は完了日でソート
                if (columnId === 'done') {
                    const dateA = a.dataset.completedDate || '';
                    const dateB = b.dataset.completedDate || '';
                    
                    // 完了日が新しい順（降順）でソート
                    if (dateA > dateB) return -1;
                    if (dateA < dateB) return 1;
                    return 0;
                }
                
                // 他のカラムは従来通り優先度と期限日でソート
                const priorityA = a.querySelector('.priority').className.split('priority-')[1].split(' ')[0];
                const priorityB = b.querySelector('.priority').className.split('priority-')[1].split(' ')[0];
                
                if (CONSTANTS.PRIORITY_WEIGHTS[priorityA] !== CONSTANTS.PRIORITY_WEIGHTS[priorityB]) {
                    return CONSTANTS.PRIORITY_WEIGHTS[priorityB] - CONSTANTS.PRIORITY_WEIGHTS[priorityA];
                }

                return TaskManager.compareDates(a, b);
            }

            static compareDates(a, b) {
                const [dueDateA, dueDateB] = [a, b].map(task => 
                    task.querySelector('.dates').textContent.split(' → ')[1]);

                if (dueDateA === '-' && dueDateB !== '-') return 1;
                if (dueDateA !== '-' && dueDateB === '-') return -1;
                if (dueDateA === '-' && dueDateB === '-') return 0;

                const [monthA, dayA] = dueDateA.split('/').map(Number);
                const [monthB, dayB] = dueDateB.split('/').map(Number);

                return monthA !== monthB ? monthA - monthB : dayA - dayB;
            }

            static saveTasks() {
                const tasks = {};
                CONSTANTS.COLUMNS.forEach(columnId => {
                    tasks[columnId] = Array.from(document.querySelectorAll(`#${columnId} .task`))
                        .map(this.extractTaskData);
                });
                localStorage.setItem('kanbanTasks', JSON.stringify(tasks));
            }

            static extractTaskData(task) {
                const [startDate, dueDate] = task.querySelector('.dates').textContent.split(' → ');
                return {
                    text: task.querySelector('.task-main').textContent,
                    startDate: startDate === '-' ? '' : utils.convertDisplayDateToISO(startDate),
                    dueDate: dueDate === '-' ? '' : utils.convertDisplayDateToISO(dueDate),
                    priority: task.querySelector('.priority').className.split('priority-')[1].split(' ')[0],
                    detail: task.dataset.detail || '',
                    completedDate: task.dataset.completedDate || ''
                };
            }

            static loadTasks() {
                const tasks = JSON.parse(localStorage.getItem('kanbanTasks'));
                if (tasks) {
                    CONSTANTS.COLUMNS.forEach(columnId => {
                        tasks[columnId]?.forEach(task => {
                            const newTask = this.createTask(
                                task.text, 
                                columnId, 
                                task.startDate, 
                                task.dueDate, 
                                task.priority || CONSTANTS.PRIORITIES.MEDIUM,
                                task.detail || '',
                                task.completedDate || ''
                            );
                            this.updateTaskStatus(newTask);
                        });
                        this.sortTasks(columnId);
                    });
                    this.updateTaskCount();
                }
            }

            static updateTaskCount() {
                CONSTANTS.COLUMNS.forEach(columnId => {
                    const column = document.getElementById(columnId);
                    const tasks = column.querySelectorAll('.task');
                    const visibleTasks = Array.from(tasks).filter(task => 
                        task.style.display !== 'none'
                    ).length;
                    
                    const header = column.querySelector('h2');
                    const columnName = this.getColumnDisplayName(columnId);
                    header.textContent = `${columnName} (${visibleTasks})`;
                });
            }

            static getColumnDisplayName(columnId) {
                switch(columnId) {
                    case 'todo':
                        return '未着手';
                    case 'in-progress':
                        return '進行中';
                    case 'done':
                        return '完了';
                    default:
                        return columnId;
                }
            }

            static exportToCSV() {
                const tasks = [];
                const headers = ['カラム', 'タイトル', '開始日', '期限日', '完了日', '重要度', '詳細'];
                tasks.push(headers);

                CONSTANTS.COLUMNS.forEach(columnId => {
                    const columnTasks = document.querySelectorAll(`#${columnId} .task`);
                    columnTasks.forEach(task => {
                        const taskData = this.extractTaskData(task);
                        const [startDate, dueDate] = task.querySelector('.dates').textContent.split(' → ');
                        tasks.push([
                            this.getColumnName(columnId),
                            taskData.text,
                            startDate,
                            dueDate,
                            taskData.completedDate ? utils.formatDate(taskData.completedDate) : '-',
                            utils.getPriorityText(taskData.priority),
                            taskData.detail
                        ]);
                    });
                });

                const csvContent = tasks.map(row => 
                    row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',')
                ).join('\n');

                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `kanban_tasks_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }

            static importFromCSV(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const rows = text.split('\n').map(row => 
                        row.split(',').map(cell => 
                            cell.trim().replace(/^"|"$/g, '').replace(/""/g, '"')
                        )
                    );

                    // ヘッダーをスキップ
                    rows.slice(1).forEach(row => {
                        if (row.length < 7) return;  // 必要な列数を7に更新
                        
                        const [columnName, title, startDate, dueDate, completedDate, priority, detail] = row;
                        const columnId = this.getColumnId(columnName);
                        if (!columnId) return;

                        const priorityKey = this.getPriorityKey(priority);
                        const formattedCompletedDate = completedDate === '-' ? '' : utils.convertDisplayDateToISO(completedDate);
                        
                        this.createTask(
                            title,
                            columnId,
                            utils.convertDisplayDateToISO(startDate),
                            utils.convertDisplayDateToISO(dueDate),
                            priorityKey,
                            detail,
                            formattedCompletedDate
                        );
                    });

                    CONSTANTS.COLUMNS.forEach(columnId => {
                        this.sortTasks(columnId);
                    });
                    this.saveTasks();
                };
                reader.readAsText(file, 'UTF-8');
            }

            static getColumnName(columnId) {
                const columnNames = {
                    'todo': '未着手',
                    'in-progress': '進行中',
                    'done': '完了'
                };
                return columnNames[columnId] || columnId;
            }

            static getColumnId(columnName) {
                const columnIds = {
                    '未着手': 'todo',
                    '進行中': 'in-progress',
                    '完了': 'done'
                };
                return columnIds[columnName];
            }

            static getPriorityKey(priorityText) {
                const priorityKeys = {
                    '高': 'high',
                    '中': 'medium',
                    '低': 'low'
                };
                return priorityKeys[priorityText] || 'medium';
            }

            static updateTaskStatus(task) {
                const datesText = task.querySelector('.dates').textContent;
                const dueDateText = datesText.split(' → ')[1];
                
                // 期限日が設定されていない場合早期リターン
                if (dueDateText === '-') {
                    task.classList.remove('overdue', 'due-soon');
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const [month, day] = dueDateText.split('/').map(Number);
                const dueDate = new Date(today.getFullYear(), month - 1, day);
                dueDate.setHours(0, 0, 0, 0);

                // クラスを一旦すべて削除
                task.classList.remove('overdue', 'due-soon');

                // 期限切れの判定（期限日が今日より前）
                if (dueDate < today) {
                    task.classList.add('overdue');
                }
                // 期限当日の判定
                else if (dueDate.getTime() === today.getTime()) {
                    task.classList.add('due-soon');
                }
            }

            static showAllTasks() {
                this.currentDateFilter = 'all';
                this.applyFilters();
            }

            static showOverdueTasks() {
                this.currentDateFilter = 'overdue';
                this.applyFilters();
            }

            static showTodayTasks() {
                this.currentDateFilter = 'today';
                this.applyFilters();
            }

            static showTasksWithoutDueDate() {
                this.currentDateFilter = 'no-due-date';
                this.applyFilters();
            }

            static showTasksWithDueDate() {
                this.currentDateFilter = 'has-due-date';
                this.applyFilters();
            }

            static filterByPriority(priority) {
                this.currentPriorityFilter = priority;
                this.applyFilters();
            }

            static applyFilters() {
                document.querySelectorAll('.task').forEach(task => {
                    const matchesDateFilter = this.checkDateFilter(task);
                    const matchesPriorityFilter = this.checkPriorityFilter(task);
                    task.style.display = matchesDateFilter && matchesPriorityFilter ? 'block' : 'none';
                });
                this.updateTaskCount();
            }

            static checkDateFilter(task) {
                if (this.currentDateFilter === 'all') return true;

                const datesText = task.querySelector('.dates').textContent;
                const dueDateText = datesText.split(' → ')[1];
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                switch (this.currentDateFilter) {
                    case 'has-due-date':
                        return dueDateText !== '-';
                    case 'no-due-date':
                        return dueDateText === '-';
                    case 'today':
                        if (dueDateText === '-') return false;
                        const [m, d] = dueDateText.split('/').map(Number);
                        const date = new Date(today.getFullYear(), m - 1, d);
                        return date.getTime() === today.getTime();
                    case 'overdue':
                        if (dueDateText === '-') return false;
                        const [month, day] = dueDateText.split('/').map(Number);
                        const dueDate = new Date(today.getFullYear(), month - 1, day);
                        return dueDate < today;
                    default:
                        return true;
                }
            }

            static checkPriorityFilter(task) {
                if (this.currentPriorityFilter === 'all') return true;
                const taskPriority = task.querySelector('.priority').className.split('priority-')[1].split(' ')[0];
                return taskPriority === this.currentPriorityFilter;
            }

            static resetAllFilters() {
                this.currentDateFilter = 'all';
                this.currentPriorityFilter = 'all';
                
                // 期限フィルターボタンの選択状態をリセット
                document.querySelectorAll('.toolbox .toolbox-group:nth-child(2) button').forEach(btn => {
                    btn.style.backgroundColor = 'white';
                    btn.style.color = '#333';
                });
                
                // 優先度フィルターをリセット
                document.querySelector('.toolbox select').value = 'all';
                
                // 全てのタスクを表示
                this.applyFilters();
            }
        }

        // イベントリスナーの設定
        document.addEventListener('DOMContentLoaded', () => {
            // タスクのみ込みとソート
            TaskManager.loadTasks();
            
            // 各種イベントリスナーの設定
            setupEventListeners();

            // 毎日0時にタスクのステータスを更新する
            setupDailyUpdate();
        });

        function setupEventListeners() {
            // ドラッグ&ドロップのイベントリスナー
            document.querySelectorAll('.task-list').forEach(taskList => {
                taskList.addEventListener('dragover', e => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                taskList.addEventListener('drop', e => {
                    e.preventDefault();
                    if (TaskManager.draggedTask) {
                        const columnId = taskList.closest('.column').id;
                        // 完了カラムにドロップされた場合、完了日を設定
                        if (columnId === 'done' && !TaskManager.draggedTask.dataset.completedDate) {
                            const today = new Date().toISOString().split('T')[0];
                            TaskManager.draggedTask.dataset.completedDate = today;
                        }
                        // 完了カラムから他のカラムに移動した場合、完了日を削除
                        if (columnId !== 'done') {
                            delete TaskManager.draggedTask.dataset.completedDate;
                        }
                        taskList.appendChild(TaskManager.draggedTask);
                        TaskManager.sortTasks(columnId);
                        TaskManager.saveTasks();
                        TaskManager.updateTaskCount();
                    }
                });
            });

            // 新規タスク追加のイベントリスナー
            document.querySelectorAll('.add-task-input').forEach(input => {
                input.addEventListener('keypress', e => {
                    if (e.key === 'Enter' && input.value.trim()) {
                        TaskManager.createTask(input.value.trim(), input.dataset.column);
                        input.value = '';
                        TaskManager.sortTasks(input.dataset.column);
                        TaskManager.saveTasks();
                    }
                });
            });

            // コンテキトメニューを閉じる
            document.addEventListener('click', e => {
                if (!e.target.closest('.context-menu')) {
                    document.getElementById('contextMenu').style.display = 'none';
                }
            });

            // コンテキストメニューのベントリスナー
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', e => {
                    const task = TaskManager.selectedTask;
                    if (!task) return;

                    switch (e.target.textContent) {
                        case 'タイトル':
                            showTitleModal(task);
                            break;
                        case '開始日':
                            showStartDateModal(task);
                            break;
                        case '期限日':
                            showDueDateModal(task);
                            break;
                        case '重要度':
                            showPriorityModal(task);
                            break;
                        case '詳細':
                            showDetailModal(task);
                            break;
                        case '削':
                            if (confirm('このタスクを削除してもよろしいですか？')) {
                                task.remove();
                                TaskManager.saveTasks();
                                TaskManager.updateTaskCount();
                                TaskManager.applyFilters(); // フィルターを再適用
                            }
                            break;
                    }
                    document.getElementById('contextMenu').style.display = 'none';
                });
            });

            // CSVエクスポート
            document.getElementById('export-csv').addEventListener('click', () => {
                TaskManager.exportToCSV();
            });

            // CSVインポート
            document.getElementById('import-csv-btn').addEventListener('click', () => {
                document.getElementById('import-csv').click();
            });

            document.getElementById('import-csv').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    if (confirm('現在のタスクに新しいタスクが追加されます。よろしいですか？')) {
                        TaskManager.importFromCSV(e.target.files[0]);
                    }
                    e.target.value = ''; // ファイル選択をリセット
                }
            });

            // 期限フィルターのイベントリスナー
            document.querySelectorAll('.toolbox .toolbox-group:first-child button').forEach(button => {
                button.addEventListener('click', (e) => {
                    // 期限フィルターボタンのスタイルを更新
                    const dateFilterButtons = document.querySelectorAll('.toolbox .toolbox-group:first-child button');
                    dateFilterButtons.forEach(btn => {
                        btn.style.backgroundColor = 'white';
                        btn.style.color = '#333';
                    });

                    // クリックされたボタンをハイライト
                    e.target.style.backgroundColor = '#4a90e2';
                    e.target.style.color = 'white';

                    switch (e.target.textContent) {
                        case '全て':
                            TaskManager.showAllTasks();
                            break;
                        case '期限あり':
                            TaskManager.showTasksWithDueDate();
                            break;
                        case '期限なし':
                            TaskManager.showTasksWithoutDueDate();
                            break;
                        case '今日期限':
                            TaskManager.showTodayTasks();
                            break;
                        case '期限切れ':
                            TaskManager.showOverdueTasks();
                            break;
                    }
                });
            });

            // 優先度フィルターのイベントリスナー
            document.querySelector('.toolbox select').addEventListener('change', (e) => {
                TaskManager.filterByPriority(e.target.value);
            });
        }

        // モーダル関連の関数を修正
        function showTitleModal(task) {
            const content = `
                <div class="form-group">
                    <label for="task-title">タイトル:</label>
                    <input type="text" id="task-title" value="${task.querySelector('.task-main').textContent}">
                </div>
            `;

            ModalManager.show('タイトルの編集', content, () => {
                const newTitle = document.getElementById('task-title').value;
                if (newTitle.trim()) {
                    task.querySelector('.task-main').textContent = newTitle;
                    TaskManager.saveTasks();
                    TaskManager.applyFilters(); // フィルターを再適用
                }
            });
        }

        function showStartDateModal(task) {
            const datesText = task.querySelector('.dates').textContent;
            const [startDateText] = datesText.split(' → ');
            const startDate = startDateText === '-' ? '' : utils.convertDisplayDateToISO(startDateText);
            const currentPriority = task.querySelector('.priority').className.split('priority-')[1].split(' ')[0];

            const content = `
                <div class="form-group">
                    <label for="start-date">開始日:</label>
                    <input type="date" id="start-date" value="${startDate}">
                    <button type="button" id="clear-start-date" style="margin-left: 8px;">日付をクリア</button>
                </div>
            `;

            ModalManager.show('開始日の編集', content, () => {
                const newStartDate = document.getElementById('start-date').value;
                const [, currentDueDate] = task.querySelector('.dates').textContent.split(' → ');
                
                task.querySelector('.task-info').innerHTML = `
                    <span class="dates">${utils.formatDate(newStartDate)} → ${currentDueDate}</span>
                    <span class="priority priority-${currentPriority}">[${utils.getPriorityText(currentPriority)}]</span>
                `;

                TaskManager.saveTasks();
                TaskManager.sortTasks(task.closest('.column').id);
                TaskManager.applyFilters(); // フィルターを再適用
            });

            // クリアボタンのイベントリスナーを追加
            document.getElementById('clear-start-date').addEventListener('click', () => {
                document.getElementById('start-date').value = '';
            });
        }

        function showDueDateModal(task) {
            const datesText = task.querySelector('.dates').textContent;
            const [, dueDateText] = datesText.split(' → ');
            const dueDate = dueDateText === '-' ? '' : utils.convertDisplayDateToISO(dueDateText);
            const currentPriority = task.querySelector('.priority').className.split('priority-')[1].split(' ')[0];

            const content = `
                <div class="form-group">
                    <label for="due-date">期限日:</label>
                    <input type="date" id="due-date" value="${dueDate}">
                    <button type="button" id="clear-due-date" style="margin-left: 8px;">日付をクリア</button>
                </div>
            `;

            ModalManager.show('期限日の編集', content, () => {
                const newDueDate = document.getElementById('due-date').value;
                const [currentStartDate] = task.querySelector('.dates').textContent.split(' → ');
                
                task.querySelector('.task-info').innerHTML = `
                    <span class="dates">${currentStartDate} → ${utils.formatDate(newDueDate)}</span>
                    <span class="priority priority-${currentPriority}">[${utils.getPriorityText(currentPriority)}]</span>
                `;

                TaskManager.updateTaskStatus(task);
                TaskManager.saveTasks();
                TaskManager.sortTasks(task.closest('.column').id);
                TaskManager.applyFilters(); // フィルターを再適用
            });

            // クリアボタンのイベントリスナーを追加
            document.getElementById('clear-due-date').addEventListener('click', () => {
                document.getElementById('due-date').value = '';
            });
        }

        function showPriorityModal(task) {
            const currentPriority = task.querySelector('.priority').className.split('priority-')[1].split(' ')[0];

            const content = `
                <div class="form-group">
                    <label for="task-priority">重要度:</label>
                    <select id="task-priority">
                        <option value="high" ${currentPriority === 'high' ? 'selected' : ''}>高</option>
                        <option value="medium" ${currentPriority === 'medium' ? 'selected' : ''}>中</option>
                        <option value="low" ${currentPriority === 'low' ? 'selected' : ''}>低</option>
                    </select>
                </div>
            `;

            ModalManager.show('重要度の編集', content, () => {
                const newPriority = document.getElementById('task-priority').value;
                const prioritySpan = task.querySelector('.priority');
                prioritySpan.className = `priority priority-${newPriority}`;
                prioritySpan.textContent = `[${utils.getPriorityText(newPriority)}]`;

                TaskManager.saveTasks();
                TaskManager.sortTasks(task.closest('.column').id);
                TaskManager.applyFilters(); // フィルターを再適用
            });
        }

        function showDetailModal(task) {
            const content = `
                <div class="form-group">
                    <label for="task-detail">詳細:</label>
                    <textarea id="task-detail" rows="4">${task.dataset.detail || ''}</textarea>
                </div>
            `;

            ModalManager.show('詳細の編集', content, () => {
                const newDetail = document.getElementById('task-detail').value.trim();
                task.dataset.detail = newDetail;
                
                let tooltip = task.querySelector('.task-tooltip');
                
                if (newDetail) {
                    if (!tooltip) {
                        tooltip = document.createElement('div');
                        tooltip.className = 'task-tooltip';
                        task.appendChild(tooltip);
                    }
                    tooltip.textContent = newDetail;
                } else {
                    if (tooltip) {
                        tooltip.remove();
                    }
                }
                
                TaskManager.attachTaskEventListeners(task);
                TaskManager.saveTasks();
                TaskManager.applyFilters(); // フィルターを再適用
            });
        }

        function handleDragStart(e) {
            e.target.classList.add('dragging');
            
            // ドラッグ時のゴーストイメージを設定
            if (e.target.parentElement.closest('#done')) {
                // 完了カラムからの場合、ゴーストイメージを透明に
                const img = new Image();
                img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                e.dataTransfer.setDragImage(img, 0, 0);
            }
            
            e.dataTransfer.setData('text/plain', e.target.id);
        }

        // 毎日0時にタスクのステータスを更新する
        function setupDailyUpdate() {
            function updateAllTasks() {
                document.querySelectorAll('.task').forEach(task => {
                    TaskManager.updateTaskStatus(task);
                });
            }

            // 初回実行
            updateAllTasks();

            // 次の0までの時間を計算
            const now = new Date();
            const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            const timeUntilMidnight = tomorrow - now;

            // 最初の0時に実行し、その後24時間ごとに実行
            setTimeout(() => {
                updateAllTasks();
                setInterval(updateAllTasks, 24 * 60 * 60 * 1000);
            }, timeUntilMidnight);
        }
    </script>
</body>
</html>